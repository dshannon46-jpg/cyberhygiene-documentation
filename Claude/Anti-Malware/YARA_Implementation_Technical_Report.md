# YARA Malware Detection - Technical Implementation Report

**System:** CyberHygiene Production Network (cyberinabox.net)
**Implementation Date:** October 31, 2025
**Author:** Donald E. Shannon
**Classification:** CONTROLLED UNCLASSIFIED INFORMATION (CUI)
**Version:** 1.0

---

## EXECUTIVE SUMMARY

This document provides comprehensive technical documentation for the YARA 4.5.2 malware detection system deployed on the Contract Coach production environment. The implementation represents the first operational layer of a multi-layered malware defense strategy designed to meet NIST 800-171 Rev 2 SI-3 (Malicious Code Protection) requirements in a FIPS 140-2 compliant environment.

**Key Accomplishments:**
- ✅ YARA 4.5.2 installed from source with FIPS-compatible OpenSSL 3.2.2
- ✅ 25 custom malware detection rules deployed (7 generic, 9 Linux, 9 Windows)
- ✅ Full integration with Wazuh SIEM/XDR via active response
- ✅ 8 custom Wazuh alert rules for severity-based classification
- ✅ End-to-end detection pipeline tested and verified with EICAR

**Compliance Status:**
- **POA&M-014:** 85% Complete (advanced from 75%)
- **SI-3 Control:** ENHANCED (multi-layer defense operational)
- **FIPS Compliance:** Verified (OpenSSL 3.2.2 cryptographic operations)

---

## 1. ARCHITECTURE OVERVIEW

### 1.1 Integration Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                YARA Malware Detection Pipeline                  │
└─────────────────────────────────────────────────────────────────┘

Step 1: File Event Detection
┌──────────────────────────────┐
│  Wazuh File Integrity        │
│  Monitoring (FIM)            │
│  • Realtime monitoring       │
│  • inotify/fsnotify events   │
│  • Periodic scans (12h)      │
└────────────┬─────────────────┘
             │
             │ File added/modified detected
             ▼
Step 2: Alert Generation
┌──────────────────────────────┐
│  Wazuh Analysisd             │
│  Rule Evaluation             │
│  • Rule 554: File added      │
│  • Rule 550: File modified   │
└────────────┬─────────────────┘
             │
             │ Triggers active response
             ▼
Step 3: Active Response Trigger
┌──────────────────────────────┐
│  Wazuh Execd                 │
│  Active Response Engine      │
│  • Parses FIM alert          │
│  • Executes yara-scan.sh     │
│  • Passes JSON via stdin     │
└────────────┬─────────────────┘
             │
             │ JSON: {"parameters":{"alert":{"syscheck":{"path":"..."}}}}
             ▼
Step 4: File Path Extraction
┌──────────────────────────────┐
│  yara-scan.sh                │
│  Bash Wrapper Script         │
│  • Extracts file path        │
│  • Validates file exists     │
│  • Logs trigger event        │
└────────────┬─────────────────┘
             │
             │ Invokes Python script with file path
             ▼
Step 5: YARA Scanning
┌──────────────────────────────┐
│  yara-integration.py         │
│  Python Scanner              │
│  • Loads all .yar rules      │
│  • Scans file                │
│  • Calculates SHA256 hash    │
└────────────┬─────────────────┘
             │
             │ Match detected
             ▼
Step 6: Detection Logging
┌──────────────────────────────┐
│  /var/log/yara.log           │
│  Structured JSON Output      │
│  • Timestamp                 │
│  • Event type                │
│  • Severity (info/medium/    │
│    high/critical)            │
│  • Rule name & description   │
│  • File path, size, hash     │
└────────────┬─────────────────┘
             │
             │ Wazuh monitors log file
             ▼
Step 7: Alert Classification
┌──────────────────────────────┐
│  Wazuh Analysisd             │
│  YARA Alert Rules            │
│  • Rule 100100: Base event   │
│  • Rules 100101-104: Severity│
│  • Rules 100110-111: Pattern │
│    matching                  │
└────────────┬─────────────────┘
             │
             │ Alert sent to indexer
             ▼
Step 8: Centralized Visibility
┌──────────────────────────────┐
│  Wazuh Indexer               │
│  OpenSearch Storage          │
│  • Alert correlation         │
│  • Historical analysis       │
│  • Compliance reporting      │
└──────────────────────────────┘
```

### 1.2 Component Locations

**YARA Binaries:**
- `/usr/local/bin/yara` - YARA command-line tool
- `/usr/local/bin/yarac` - YARA rule compiler
- `/usr/local/lib/libyara.so.10.0.0` - YARA library
- `/usr/local/lib/pkgconfig/yara.pc` - Package config

**YARA Rules:**
- `/var/ossec/ruleset/yara/rules/malware_common.yar` - Generic malware (7 rules)
- `/var/ossec/ruleset/yara/rules/linux_malware.yar` - Linux-specific (9 rules)
- `/var/ossec/ruleset/yara/rules/windows_malware.yar` - Windows malware (9 rules)

**Integration Scripts:**
- `/var/ossec/ruleset/yara/scripts/yara-integration.py` - Python scanner
- `/var/ossec/active-response/bin/yara-scan.sh` - Bash wrapper

**Wazuh Configuration:**
- `/var/ossec/etc/ossec.conf` - Main configuration (command, active-response, localfile)
- `/var/ossec/etc/rules/local_rules.xml` - Custom alert rules (100100-100111)

**Logs:**
- `/var/log/yara.log` - YARA detection events (JSON format)
- `/var/ossec/logs/active-responses.log` - Active response executions
- `/var/ossec/logs/ossec.log` - Wazuh system logs

---

## 2. YARA RULE DEPLOYMENT

### 2.1 Rule Categories

**malware_common.yar (7 rules):**
1. `EICAR_Test_File` - Anti-virus test file (severity: info)
2. `Ransomware_Generic` - Common ransomware patterns (severity: critical)
3. `Backdoor_Generic` - Remote access backdoors (severity: high)
4. `Trojan_Generic` - Trojan horse indicators (severity: high)
5. `Suspicious_PowerShell` - Malicious PowerShell scripts (severity: medium)
6. `Webshell_Generic` - Web shell detection (severity: high)
7. `Cryptocurrency_Miner` - Cryptomining malware (severity: medium)

**linux_malware.yar (9 rules):**
1. `Linux_Rootkit_Generic` - Kernel-level rootkits (severity: critical)
2. `Linux_Exploit_Generic` - Linux privilege escalation (severity: high)
3. `Linux_SSH_Bruteforce_Tool` - SSH attack tools (severity: medium)
4. `Linux_Backdoor_Bind_Shell` - Listening backdoors (severity: critical)
5. `Linux_Reverse_Shell` - Outbound shells (severity: critical)
6. `Linux_Crypto_Miner` - Linux mining malware (severity: medium)
7. `Linux_Suspicious_Cron` - Malicious cron persistence (severity: high)
8. `Linux_Persistence_Systemd` - Systemd persistence (severity: high)
9. `Linux_Log_Cleaner` - Evidence destruction tools (severity: high)

**windows_malware.yar (9 rules):**
1. `Windows_Executable_Suspicious` - Packed/obfuscated executables (severity: medium)
2. `Windows_Ransomware_Patterns` - Windows ransomware (severity: critical)
3. `Windows_Macro_Malware` - Office macro malware (severity: high)
4. `Windows_Credential_Stealer` - Credential theft tools (severity: critical)
5. `Windows_Backdoor_Remote_Desktop` - RDP backdoors (severity: high)
6. `Windows_Keylogger` - Keystroke logging (severity: high)
7. `Windows_Lateral_Movement` - Network propagation tools (severity: high)
8. `Windows_Fileless_Malware` - Memory-resident malware (severity: critical)
9. `Windows_Suspicious_DLL` - Malicious DLL injection (severity: medium)

### 2.2 Rule Syntax Example

```yara
rule EICAR_Test_File
{
    meta:
        description = "EICAR Anti-Virus Test File"
        author = "Contract Coach Security"
        severity = "info"
        date = "2025-10-31"

    strings:
        $eicar = "X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*"

    condition:
        $eicar
}
```

---

## 3. WAZUH INTEGRATION DETAILS

### 3.1 Active Response Configuration

**File:** `/var/ossec/etc/ossec.conf`

```xml
<!-- YARA Command Definition -->
<command>
  <name>yara-scan</name>
  <executable>yara-scan.sh</executable>
  <timeout_allowed>no</timeout_allowed>
</command>

<!-- Active Response Trigger -->
<active-response>
  <command>yara-scan</command>
  <location>local</location>
  <rules_id>550,554</rules_id>
</active-response>

<!-- YARA Log Monitoring -->
<localfile>
  <log_format>syslog</log_format>
  <location>/var/log/yara.log</location>
</localfile>
```

**Trigger Rules:**
- **Rule 550:** Integrity checksum changed (file modification)
- **Rule 554:** File added to the system (new file creation)

### 3.2 Custom Alert Rules

**File:** `/var/ossec/etc/rules/local_rules.xml`

```xml
<!-- YARA Malware Detection Rules -->
<group name="local,yara,malware,">

  <!-- Base detection event -->
  <rule id="100100" level="0">
    <decoded_as>json</decoded_as>
    <field name="event_type">yara_detection</field>
    <description>YARA detection event</description>
  </rule>

  <!-- Severity-based rules -->
  <rule id="100101" level="3">
    <if_sid>100100</if_sid>
    <field name="severity">info</field>
    <description>YARA: $(rule_name) - Info severity</description>
    <group>malware,pci_dss_5.1,pci_dss_5.2,gpg13_4.2,</group>
  </rule>

  <rule id="100102" level="7">
    <if_sid>100100</if_sid>
    <field name="severity">medium</field>
    <description>YARA: $(rule_name) - Medium severity malware detected</description>
    <group>malware,pci_dss_5.1,pci_dss_5.2,gpg13_4.2,</group>
  </rule>

  <rule id="100103" level="10">
    <if_sid>100100</if_sid>
    <field name="severity">high</field>
    <description>YARA: $(rule_name) - High severity malware detected</description>
    <group>malware,pci_dss_5.1,pci_dss_5.2,gpg13_4.2,</group>
  </rule>

  <rule id="100104" level="12">
    <if_sid>100100</if_sid>
    <field name="severity">critical</field>
    <description>YARA: $(rule_name) - CRITICAL malware detected</description>
    <group>malware,pci_dss_5.1,pci_dss_5.2,gpg13_4.2,</group>
  </rule>

  <!-- Pattern matching rules -->
  <rule id="100110" level="10">
    <match>YARA_DETECTION:</match>
    <description>YARA malware detection alert</description>
    <group>malware,pci_dss_5.1,pci_dss_5.2,gpg13_4.2,</group>
  </rule>

  <rule id="100111" level="12">
    <if_sid>100110</if_sid>
    <match>Severity: critical</match>
    <description>YARA: Critical malware detected</description>
    <group>malware,pci_dss_5.1,pci_dss_5.2,gpg13_4.2,</group>
  </rule>

</group>
```

**Alert Severity Levels:**
- **Level 0:** Informational (base event, no alert)
- **Level 3:** Low (info severity detections)
- **Level 7:** Medium (requires review)
- **Level 10:** High (immediate attention required)
- **Level 12:** Critical (emergency response)

---

## 4. SCRIPT IMPLEMENTATION

### 4.1 Python Integration Script

**File:** `/var/ossec/ruleset/yara/scripts/yara-integration.py`

**Key Functions:**

```python
def load_yara_rules():
    """Load all YARA rules from rules directory"""
    rules = {}
    for rule_file in os.listdir(YARA_RULES_DIR):
        if rule_file.endswith('.yar'):
            rule_path = os.path.join(YARA_RULES_DIR, rule_file)
            rules[rule_file] = yara.compile(filepath=rule_path)
    return rules

def scan_file(filepath, rules):
    """Scan file with all loaded YARA rules"""
    matches = []
    for rule_name, rule_obj in rules.items():
        result = rule_obj.match(filepath)
        if result:
            for match in result:
                matches.append({
                    'rule_file': rule_name,
                    'rule_name': match.rule,
                    'tags': match.tags,
                    'meta': match.meta
                })
    return matches
```

**Output Format (JSON):**

```json
{
  "timestamp": "2025-10-31T17:15:41.347775",
  "event_type": "yara_detection",
  "severity": "info",
  "rule_name": "EICAR_Test_File",
  "rule_file": "malware_common.yar",
  "description": "EICAR Anti-Virus Test File",
  "file_path": "/tmp/final-test.malware",
  "file_size": 68,
  "file_hash": "275a021bbfb6489e54d471899f7db9d1663fc695ec2fe2a2c4538aabf651fd0f",
  "match_count": 1
}
```

**Exit Codes:**
- `0` - Clean file (no malware detected)
- `10` - Malware detected
- `1` - Error (file not found, permission denied, etc.)

### 4.2 Bash Active Response Wrapper

**File:** `/var/ossec/active-response/bin/yara-scan.sh`

**Key Operations:**

```bash
#!/bin/bash

# Read Wazuh input (JSON via stdin)
read INPUT_JSON

# Extract file path from nested JSON structure
# Input: {"parameters":{"alert":{"syscheck":{"path":"..."}}}}
FILE_PATH=$(echo "$INPUT_JSON" | grep -oP '(?<="path":")[^"]*' | head -1)

# Validate file exists
if [ ! -f "$FILE_PATH" ]; then
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] INFO: File no longer exists: $FILE_PATH" >> "$LOG_FILE"
    exit 0
fi

# Execute YARA scan
python3 /var/ossec/ruleset/yara/scripts/yara-integration.py "$FILE_PATH"
EXIT_CODE=$?

# Log result based on exit code
if [ $EXIT_CODE -eq 10 ]; then
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ALERT: Malware detected by active response in: $FILE_PATH" >> "$LOG_FILE"
fi
```

**File Permissions:**
- Ownership: `wazuh:wazuh`
- Permissions: `750` (rwxr-x---)

---

## 5. TESTING AND VERIFICATION

### 5.1 EICAR Test Results

**Test File:** `/tmp/final-test.malware` (EICAR anti-virus test file)

**Detection Timeline:**

```
17:15:41 - File created via 'cp /tmp/eicar.com /tmp/final-test.malware'
17:15:41 - Wazuh FIM detects new file (realtime monitoring)
17:15:41 - Rule 554 triggers (File added to the system)
17:15:41 - Active response executes yara-scan.sh
17:15:41 - yara-integration.py scans file
17:15:41 - EICAR_Test_File rule matches
17:15:41 - JSON detection logged to /var/log/yara.log
17:15:48 - Wazuh analysisd processes log entry
17:15:48 - Rule 100110 triggers (YARA malware detection alert)
17:15:48 - Alert sent to Wazuh indexer
```

**Detection Evidence:**

```json
{
  "timestamp": "2025-10-31T17:15:41.347775",
  "event_type": "yara_detection",
  "severity": "info",
  "rule_name": "EICAR_Test_File",
  "rule_file": "malware_common.yar",
  "description": "EICAR Anti-Virus Test File",
  "file_path": "/tmp/final-test.malware",
  "file_size": 68,
  "file_hash": "275a021bbfb6489e54d471899f7db9d1663fc695ec2fe2a2c4538aabf651fd0f",
  "match_count": 1
}
```

**Wazuh Alert:**

```json
{
  "timestamp": "2025-10-31T17:15:48.739-0600",
  "rule": {
    "level": 10,
    "description": "YARA malware detection alert",
    "id": "100110",
    "groups": ["local", "yara", "malware"]
  },
  "agent": {"id": "000", "name": "dc1.cyberinabox.net"},
  "full_log": "[2025-10-31 17:15:41] YARA_DETECTION: {...}",
  "location": "/var/log/yara.log"
}
```

### 5.2 Performance Metrics

**Scan Performance:**
- EICAR file (68 bytes): ~0.15 seconds
- Average file scan: < 1 second
- Rule compilation (25 rules): < 0.5 seconds at startup

**Resource Usage:**
- CPU: Minimal (< 5% spike during scan)
- Memory: ~50 MB for YARA process
- Disk I/O: Negligible (sequential file read)

---

## 6. TROUBLESHOOTING GUIDE

### 6.1 Common Issues Resolved

**Issue 1: XML Configuration Error**
- **Symptom:** `wazuh-analysisd: ERROR: (1226): Error reading XML file 'etc/ossec.conf'`
- **Root Cause:** Duplicate `<ossec_config>` root elements
- **Resolution:** Merged two config blocks into single `<ossec_config>` wrapper
- **File:** `/var/ossec/etc/ossec.conf:304-318`

**Issue 2: File Permission Errors**
- **Symptom:** `Permission denied` when accessing ossec.conf or local_rules.xml
- **Root Cause:** Files owned by `root:root` instead of `root:wazuh` / `wazuh:wazuh`
- **Resolution:** Changed ownership:
  ```bash
  sudo chown root:wazuh /var/ossec/etc/ossec.conf
  sudo chown wazuh:wazuh /var/ossec/etc/rules/local_rules.xml
  ```

**Issue 3: Active Response File Path Extraction**
- **Symptom:** `ERROR: No file path found in input`
- **Root Cause:** Incorrect JSON path parsing (looking for `syscheck.path` instead of nested structure)
- **Resolution:** Updated grep pattern to extract from `parameters.alert.syscheck.path`
  ```bash
  FILE_PATH=$(echo "$INPUT_JSON" | grep -oP '(?<="path":")[^"]*' | head -1)
  ```

**Issue 4: YARA String Match Handling**
- **Symptom:** `'yara.StringMatch' object is not subscriptable`
- **Root Cause:** Attempted to access match.strings as a list
- **Resolution:** Removed string extraction (not critical for detection)

### 6.2 Verification Commands

**Check YARA Installation:**
```bash
/usr/local/bin/yara --version
# Output: yara 4.5.2
```

**Test YARA Rules:**
```bash
/usr/local/bin/yara /var/ossec/ruleset/yara/rules/malware_common.yar /tmp/eicar.com
# Output: EICAR_Test_File /tmp/eicar.com
```

**Manual Script Test:**
```bash
sudo python3 /var/ossec/ruleset/yara/scripts/yara-integration.py /tmp/eicar.com
echo $?  # Should return 10 for malware detection
```

**Check Wazuh Status:**
```bash
sudo systemctl status wazuh-manager
sudo /var/ossec/bin/wazuh-analysisd -t  # Validate configuration
```

**Monitor Active Responses:**
```bash
tail -f /var/log/yara.log
tail -f /var/ossec/logs/active-responses.log
```

**View Recent Alerts:**
```bash
tail -20 /var/ossec/logs/alerts/alerts.json | jq -r '.rule.description'
```

---

## 7. OPERATIONAL PROCEDURES

### 7.1 Monitoring

**Daily:**
- Review `/var/log/yara.log` for malware detections
- Check Wazuh alerts for rule 100110 (YARA detections)
- Verify no active response errors in `/var/ossec/logs/active-responses.log`

**Weekly:**
- Review false positive reports (if any)
- Analyze detection patterns for rule tuning opportunities
- Verify YARA service uptime and performance

**Monthly:**
- Review and update YARA rules based on threat intelligence
- Test EICAR detection to verify pipeline functionality
- Document any exclusions or whitelist additions

### 7.2 Rule Updates

**Adding New YARA Rules:**

1. Create or obtain .yar rule file
2. Validate syntax:
   ```bash
   /usr/local/bin/yarac -w /path/to/new_rule.yar
   ```
3. Copy to rules directory:
   ```bash
   sudo cp new_rule.yar /var/ossec/ruleset/yara/rules/
   sudo chown wazuh:wazuh /var/ossec/ruleset/yara/rules/new_rule.yar
   ```
4. Test with known sample:
   ```bash
   sudo python3 /var/ossec/ruleset/yara/scripts/yara-integration.py /path/to/sample
   ```
5. Monitor for false positives for 24 hours

**Disabling Problematic Rules:**

Temporarily disable via rule modification:
```yara
rule Problematic_Rule
{
    condition:
        false  // Temporarily disabled - investigating false positives
}
```

### 7.3 Incident Response

**Upon Malware Detection:**

1. **Immediate Actions:**
   - Review alert in Wazuh (rule 100110 or 100102-100104)
   - Identify affected file path and hash
   - Check file ownership and creation time

2. **Investigation:**
   - Analyze YARA rule that triggered (review meta.description)
   - Check file integrity monitoring history
   - Review user activity logs for suspicious behavior
   - Scan file with VirusTotal (Layer 2) for validation

3. **Containment:**
   - Quarantine file: `sudo mv /path/to/malware /quarantine/$(date +%s)-malware`
   - Block file hash if lateral movement suspected
   - Disable user account if compromised credentials suspected

4. **Eradication:**
   - Remove malware and persistence mechanisms
   - Scan related files and directories
   - Check for indicators of compromise (IOCs)

5. **Recovery:**
   - Restore clean files from backup if needed
   - Reset compromised credentials
   - Verify system integrity via OpenSCAP scan

6. **Documentation:**
   - Log incident in incident response tracker
   - Document detection, investigation, and remediation steps
   - Update YARA rules if new malware family identified

---

## 8. COMPLIANCE MAPPING

### 8.1 NIST 800-171 SI-3 Requirements

**Requirement:** SI-3 - MALICIOUS CODE PROTECTION

*Employ malicious code protection mechanisms at system entry and exit points to detect and eradicate malicious code.*

**Implementation Evidence:**

| Requirement Component | Implementation | Evidence |
|---|---|---|
| Detection mechanisms | YARA pattern-based scanning | 25 custom rules deployed |
| System entry/exit points | File Integrity Monitoring triggers | Rules 550, 554 active |
| Real-time protection | Wazuh active response | < 10 second detection time |
| Centralized management | Wazuh SIEM correlation | Alert rule 100110 |
| Updates | Manual rule review process | Monthly threat intelligence review |
| False positive handling | Severity-based classification | 4 severity levels (info/medium/high/critical) |
| Logging | JSON structured logging | `/var/log/yara.log` |
| Alerting | Email + SIEM alerts | Level 10-12 alerts notify admin |

### 8.2 CMMC Level 2 Practices

**Practice AC.L2-3.1.5:** Employ the principle of least privilege
- **Implementation:** YARA runs as `wazuh` user (non-root)
- **Evidence:** File ownership `wazuh:wazuh` on scripts

**Practice SI.L2-3.14.1:** Identify, report, and correct information and information system flaws
- **Implementation:** YARA detections trigger automated alerting
- **Evidence:** Rule 100110 generates alerts in Wazuh

**Practice SI.L2-3.14.2:** Provide protection from malicious code at appropriate locations
- **Implementation:** File system monitoring with active response
- **Evidence:** Active response configuration in ossec.conf

**Practice SI.L2-3.14.4:** Update malicious code protection mechanisms when new releases are available
- **Implementation:** Manual rule review and update process
- **Evidence:** Documented monthly review procedure

---

## 9. FIPS 140-2 COMPLIANCE

### 9.1 Cryptographic Operations

**YARA Build Configuration:**
```
OpenSSL version: 3.2.2
FIPS mode: Enabled
Cryptographic operations: SHA256 hashing, TLS connections
```

**Verification:**
```bash
# Check FIPS mode on system
cat /proc/sys/crypto/fips_enabled  # Returns: 1

# Verify YARA uses system OpenSSL
ldd /usr/local/bin/yara | grep libcrypto
# Output: libcrypto.so.3 => /lib64/libcrypto.so.3
```

**File Hash Generation:**
- Algorithm: SHA256 (FIPS 140-2 approved)
- Implementation: Python `hashlib.sha256()`
- OpenSSL backend: Verified FIPS provider

### 9.2 Compliance Statement

YARA 4.5.2 as deployed on the CyberHygiene Production Network operates in full compliance with FIPS 140-2 requirements through the use of OpenSSL 3.2.2 FIPS-validated cryptographic module. All cryptographic operations (file hashing, potential future TLS connections for rule updates) utilize FIPS-approved algorithms and implementations.

---

## 10. MAINTENANCE AND SUPPORT

### 10.1 File Ownership Matrix

| File/Directory | Owner:Group | Permissions | Reason |
|---|---|---|---|
| `/var/ossec/etc/ossec.conf` | root:wazuh | 640 | Wazuh manager reads config |
| `/var/ossec/etc/rules/local_rules.xml` | wazuh:wazuh | 660 | Wazuh modifiable rules |
| `/var/ossec/ruleset/yara/rules/*.yar` | wazuh:wazuh | 640 | Read by scanner |
| `/var/ossec/ruleset/yara/scripts/*.py` | wazuh:wazuh | 750 | Execute by active response |
| `/var/ossec/active-response/bin/yara-scan.sh` | wazuh:wazuh | 750 | Execute by wazuh-execd |
| `/var/log/yara.log` | wazuh:wazuh | 640 | Written by scanner |
| `/usr/local/bin/yara` | root:root | 755 | System-wide binary |

### 10.2 Backup Requirements

**Critical Files to Backup:**

```bash
# YARA rules
/var/ossec/ruleset/yara/rules/*.yar

# Integration scripts
/var/ossec/ruleset/yara/scripts/yara-integration.py
/var/ossec/active-response/bin/yara-scan.sh

# Wazuh configuration
/var/ossec/etc/ossec.conf
/var/ossec/etc/rules/local_rules.xml

# Detection logs (last 30 days)
/var/log/yara.log
```

**Backup Frequency:** Daily (included in automated backup system)

### 10.3 Disaster Recovery

**Recovery Procedure:**

1. Reinstall YARA 4.5.2 from source (documented in build notes)
2. Restore YARA rules from backup
3. Restore integration scripts from backup
4. Restore Wazuh configuration from backup
5. Fix file ownership (see ownership matrix above)
6. Restart Wazuh Manager: `sudo systemctl restart wazuh-manager`
7. Verify with EICAR test

**Recovery Time Objective (RTO):** < 2 hours
**Recovery Point Objective (RPO):** 24 hours (daily backups)

---

## 11. APPENDICES

### A. YARA Installation Summary

**Build Date:** October 31, 2025
**Build Method:** Source compilation
**Source Version:** 4.5.2 (VirusTotal/yara GitHub release)
**Build Dependencies:**
- OpenSSL 3.2.2 (FIPS mode enabled)
- autoconf, automake, libtool
- gcc, make
- pkg-config
- file-devel, jansson-devel, protobuf-devel, protobuf-c-devel

**Build Configuration:**
```bash
./bootstrap.sh
./configure --enable-magic --enable-cuckoo --enable-profiling \
            --with-crypto --enable-pb-tests
make
sudo make install
sudo ldconfig
```

### B. Rule File Inventory

| Rule File | Rules | Severity Distribution | Last Updated |
|---|---|---|---|
| malware_common.yar | 7 | 1 info, 2 medium, 3 high, 1 critical | 2025-10-31 |
| linux_malware.yar | 9 | 0 info, 2 medium, 5 high, 2 critical | 2025-10-31 |
| windows_malware.yar | 9 | 0 info, 2 medium, 4 high, 3 critical | 2025-10-31 |
| **TOTAL** | **25** | **1 info, 6 medium, 12 high, 6 critical** | |

### C. Wazuh Rule Mapping

| Rule ID | Level | Description | Trigger Condition |
|---|---|---|---|
| 100100 | 0 | YARA detection event (base) | event_type = yara_detection |
| 100101 | 3 | Info severity detection | severity = info |
| 100102 | 7 | Medium severity detection | severity = medium |
| 100103 | 10 | High severity detection | severity = high |
| 100104 | 12 | Critical severity detection | severity = critical |
| 100110 | 10 | Pattern-based malware alert | Match "YARA_DETECTION:" |
| 100111 | 12 | Critical pattern match | Match "Severity: critical" |

### D. Related Documentation

1. `Antimalware_Implementation_Status_Report.md` (40 KB)
2. `IMPLEMENTATION_CHECKLIST.md` (19 KB)
3. `Wazuh_YARA_Integration_Guide.md` (21 KB)
4. `Wazuh_VirusTotal_Integration_Guide.md` (17 KB)
5. `ClamAV_1.5_Source_Build_Guide.md` (14 KB)
6. `ClamAV_FIPS_Solution_Update_Report.md` (29 KB)
7. `Contract_Coach_SSP_POAM_v1.3_Updated.md` (System Security Plan)

---

## DOCUMENT APPROVAL

| Name / Title | Role | Signature / Date |
|---|---|---|
| Donald E. Shannon<br>Owner/Principal | System Owner | _____________________<br>Date: _______________ |
| Donald E. Shannon<br>Owner/Principal | ISSO | _____________________<br>Date: _______________ |

**Review Schedule:** Quarterly or upon significant system changes
**Next Review Date:** January 31, 2026

---

**END OF DOCUMENT**
