# Chapter 26: Malware Detection Alerts

## 26.1 Malware Detection Overview

### Detection Systems

The CyberHygiene Production Network employs multiple layers of malware detection:

**Detection Stack:**

```
Layer 1: ClamAV (Antivirus)
  - Real-time file scanning
  - On-access protection
  - Daily signature updates
  - Scan all downloads and email attachments

Layer 2: YARA (Malware Pattern Matching)
  - Advanced pattern detection
  - Custom rules for targeted threats
  - Memory and file scanning
  - Behavioral analysis

Layer 3: Wazuh (SIEM Integration)
  - Aggregates alerts from all sources
  - Correlates events across systems
  - High-severity alerting (level 12+)
  - Automated response actions

Layer 4: Suricata (Network-Based)
  - Network traffic inspection
  - Malware download attempts
  - Command & control communication
  - Exploit kit detection

Layer 5: AIDE (File Integrity)
  - Detects unauthorized file modifications
  - Catches rootkits and backdoors
  - System file integrity verification
  - Configuration tampering detection
```

### Current Status

**System Health (as of Phase I completion):**

```
Malware Detections: 0 (clean environment)
False Positives: Minimal (well-tuned rules)
Signature Updates: Daily (automated)
System Coverage: 100% (all servers protected)

YARA Statistics:
  - Files scanned: 1,247,633
  - Malware detected: 0
  - Suspicious patterns: 0
  - Last scan: Daily

ClamAV Statistics:
  - Definitions: Updated daily
  - Files scanned: Continuous
  - Threats detected: 0
  - Quarantine: Empty (no threats)
```

## 26.2 Types of Malware Alerts

### Alert Severity Levels

**Critical (Immediate Action Required):**

```
Wazuh Level 12-15:
  - Active malware execution
  - Ransomware detected
  - Rootkit installation
  - Remote access trojan (RAT)
  - Command & control communication

Example Alert:
  Level: 15 (CRITICAL)
  Rule: Malware Execution Detected
  Description: Ransomware encryption activity on /home/username
  Action: IMMEDIATE - Isolate system from network

Response: Automated system isolation + immediate security team notification
```

**High (Urgent Investigation):**

```
Wazuh Level 10-11:
  - Malware file detected (not executed)
  - Suspicious executable downloaded
  - Known malicious hash
  - Exploit attempt detected
  - YARA rule match

Example Alert:
  Level: 11 (HIGH)
  Rule: Malicious File Detected
  Description: Trojan.Generic found in /home/username/Downloads/
  Action: File quarantined, investigate download source

Response: File automatically quarantined, user notified, investigate origin
```

**Medium (Investigation Warranted):**

```
Wazuh Level 7-9:
  - Suspicious file patterns
  - Potentially unwanted program (PUP)
  - Unusual file behavior
  - Script execution from tmp directory

Example Alert:
  Level: 8 (MEDIUM)
  Rule: Suspicious Pattern Detected
  Description: Script execution from /tmp/ directory
  Action: Review user activity, determine if legitimate

Response: Log review, user interview, determine legitimacy
```

**Low (Informational):**

```
Wazuh Level 3-6:
  - Failed exploit attempts (blocked)
  - Suspicious connection blocked by firewall
  - Known bad IP contacted (connection denied)
  - Scan attempt detected and blocked

Example Alert:
  Level: 6 (LOW)
  Rule: Malware Download Blocked
  Description: Connection to known malware site blocked
  Action: Logged for tracking, no immediate action required

Response: Monitored, added to indicators, user may be notified
```

### Common Malware Types

**1. Ransomware**

```
Characteristics:
  - Encrypts user files
  - Demands payment for decryption
  - Often spreads rapidly
  - Leaves ransom note file

Detection Indicators:
  - Rapid file modifications
  - File extensions changed (e.g., .encrypted, .locked)
  - Unusual encryption activity
  - Ransom note files (README.txt, HOW_TO_DECRYPT.txt)

Alert Example:
  [CRITICAL] Ransomware activity detected
  Files being encrypted: /home/username/Documents/
  Action: System isolated, encryption halted
  Status: 45 files encrypted, 12,450 files protected

Immediate Response:
  1. System automatically isolated from network
  2. Processes terminated
  3. Security team notified (SMS + email)
  4. User session locked
  5. Restore from backup initiated
```

**2. Trojans**

```
Characteristics:
  - Disguised as legitimate software
  - Provides unauthorized remote access
  - Often bundled with other software
  - May download additional malware

Detection Indicators:
  - Unexpected outbound connections
  - Unknown processes running
  - Modified system files
  - Unusual network traffic

Alert Example:
  [HIGH] Trojan detected in downloaded file
  File: /home/username/Downloads/invoice.pdf.exe
  Hash: a1b2c3d4e5f6g7h8i9j0
  Threat: Trojan.Generic.12345
  Action: File quarantined

Response:
  1. File moved to quarantine: /var/quarantine/
  2. User notified via Wazuh dashboard
  3. Download source investigated
  4. Email/web filters updated
  5. Full system scan initiated
```

**3. Worms**

```
Characteristics:
  - Self-replicating
  - Spreads across network
  - Exploits vulnerabilities
  - Can cause network congestion

Detection Indicators:
  - Network traffic spike
  - Scanning activity
  - Multiple systems affected simultaneously
  - Exploit attempts logged

Alert Example:
  [CRITICAL] Worm propagation detected
  Source: workstation-05.cyberinabox.net
  Target: Multiple systems (scanning 192.168.1.0/24)
  Exploit: MS17-010 (EternalBlue)
  Action: Source isolated, targets scanned

Response:
  1. Source system quarantined
  2. Network segmentation activated
  3. All systems scanned for infection
  4. Patches verified on all systems
  5. Vulnerability assessment initiated
```

**4. Spyware/Keyloggers**

```
Characteristics:
  - Monitors user activity
  - Captures keystrokes
  - Screenshots user activity
  - Exfiltrates sensitive data

Detection Indicators:
  - Unusual data uploads
  - Keyboard monitoring software
  - Screen capture processes
  - Credentials harvested

Alert Example:
  [HIGH] Keylogger detected
  Process: svchost.exe (suspicious location)
  Path: /home/username/.hidden/
  Behavior: Logging keystrokes to file
  Action: Process terminated, file removed

Response:
  1. Malicious process killed
  2. Keystroke log file secured (evidence)
  3. User credentials reset immediately
  4. Account activity reviewed
  5. Systems accessing same data scanned
```

**5. Rootkits**

```
Characteristics:
  - Hides malware presence
  - Provides privileged access
  - Modifies system files
  - Very difficult to detect

Detection Indicators:
  - AIDE file integrity violations
  - Hidden processes or files
  - Modified system binaries
  - Kernel module anomalies

Alert Example:
  [CRITICAL] Rootkit detected
  Type: Kernel-mode rootkit
  Modified: /bin/ls, /bin/ps, /bin/netstat
  Severity: Complete system compromise
  Action: System quarantine, forensic analysis

Response:
  1. System taken offline immediately
  2. Forensic image created
  3. System wiped and rebuilt from known-good media
  4. All credentials rotated
  5. Network-wide scan initiated
  6. Incident response team activated
```

## 26.3 Alert Notifications

### How You'll Be Notified

**Dashboard Alerts (Real-Time):**

```
Wazuh Dashboard:
  Location: https://wazuh.cyberinabox.net
  Alert Display: Red badge with count
  Details: Click alert for full information

Grafana YARA Dashboard:
  Location: https://grafana.cyberinabox.net
  Dashboard: YARA Malware Detection
  Visualization: Alert counter, threat timeline

CPM Dashboard:
  Location: https://cpm.cyberinabox.net
  Indicator: Security status (Green/Yellow/Red)
  Summary: High-level threat count
```

**Email Alerts (High/Critical):**

```
From: Wazuh Security <wazuh@cyberinabox.net>
To: your_email@cyberinabox.net
Subject: [CRITICAL ALERT] Malware Detected on [hostname]

A critical security alert has been triggered on your system.

System: workstation-05.cyberinabox.net
User: jsmith
Alert Level: 12 (CRITICAL)
Rule: Malware Execution Detected
Timestamp: 2025-12-31 14:30:45

Details:
File: /home/jsmith/Downloads/invoice.pdf.exe
Threat: Trojan.Generic.12345
Hash: a1b2c3d4e5f6g7h8i9j0
Status: File quarantined

IMMEDIATE ACTIONS REQUIRED:
1. Do NOT attempt to access the file
2. Do NOT click any suspicious links
3. Change your password immediately
4. Contact security team: security@cyberinabox.net
5. Await further instructions

Your system may be automatically isolated from the network
to prevent spread. This is normal procedure.

Security Team: security@cyberinabox.net
Emergency: [Phone number from Chapter 5]
```

**On-Screen Notification (Desktop):**

```
For users logged into affected system:

[!] SECURITY ALERT

Malware detected on your system.

Threat: Trojan detected in Downloads folder
Action: File has been quarantined
Status: Security team notified

What to do:
- DO NOT open any suspicious files
- Change your password
- Contact security team

[View Details] [Contact Security]
```

**SMS/Text (Critical Only):**

```
For critical threats to privileged accounts:

CyberHygiene Security Alert:
CRITICAL malware detected on dc1.
Action required. Call [number] immediately.
- Security Team
```

### Alert Details

**Full Alert Information (in Wazuh):**

```
Alert ID: 1234567
Timestamp: 2025-12-31 14:30:45
Rule ID: 87105
Level: 12 (CRITICAL)
Rule: Malware Execution Detected

Agent:
  Name: workstation-05.cyberinabox.net
  IP: 192.168.1.45
  OS: Rocky Linux 9.5

User: jsmith

File Information:
  Path: /home/jsmith/Downloads/invoice.pdf.exe
  Hash (SHA256): a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
  Size: 234,567 bytes
  Permissions: -rw-r--r--
  Owner: jsmith:jsmith

Threat Classification:
  Type: Trojan
  Family: Generic
  Signature: Trojan.Generic.12345
  Confidence: High (95%)
  Source: ClamAV + YARA correlation

Behavior Observed:
  - Outbound connection attempt to 203.0.113.45:443
  - Process injection attempt detected
  - Credential harvesting behavior

Actions Taken:
  - File quarantined to /var/quarantine/
  - Process terminated (PID 12345)
  - Outbound connection blocked by firewall
  - User session locked
  - Security team notified

Recommended Actions:
  1. User password reset (IMMEDIATE)
  2. Full system scan
  3. Review recent file downloads
  4. Check for additional indicators of compromise
  5. Interview user about file source

Related Alerts:
  - None (isolated incident)

Incident Status: OPEN
Assigned To: Security Team
```

## 26.4 User Response Actions

### When You Receive an Alert

**Step 1: Don't Panic (0-30 seconds)**

```
Take a breath. Alerts are designed to protect you.

✓ Alert means detection is working
✓ Many threats are automatically blocked
✓ Security team is already notified
✓ Follow standard procedures
```

**Step 2: Read the Alert Carefully (30 seconds)**

```
Understand:
  - What was detected?
  - Where was it found?
  - What action was taken?
  - What do you need to do?

Key Questions:
  □ Was malware executed or just detected?
  □ Is file quarantined or still accessible?
  □ Is system isolated or still connected?
  □ What is the threat level?
```

**Step 3: Take Immediate Actions (1-5 minutes)**

**For CRITICAL Alerts (Level 12+):**

```
IMMEDIATE (Do within 1 minute):

1. STOP what you're doing
   - Don't click anything else
   - Don't open any files
   - Don't close the alert

2. ISOLATE (if not already done automatically)
   - Unplug network cable, OR
   - Disable WiFi
   - Disconnect from VPN

3. PRESERVE evidence
   - Don't delete anything
   - Don't try to "clean" the system
   - Take screenshots of alerts
   - Note exact time

4. NOTIFY security team
   - Email: security@cyberinabox.net
   - Subject: [CRITICAL] Malware Alert - [Your Name]
   - Include: Alert details, what you were doing

5. CHANGE password (from different device)
   - Use different computer or phone
   - Login to: https://dc1.cyberinabox.net
   - Change password immediately
   - Use strong, unique password
```

**For HIGH Alerts (Level 10-11):**

```
WITHIN 5 MINUTES:

1. Review alert details
   - What file was detected?
   - Do you recognize it?
   - Where did it come from?

2. If you downloaded the file:
   - When did you download it?
   - From where? (email, website, USB)
   - Why did you download it?
   - Did you open/execute it?

3. Preserve the evidence
   - Don't delete the email or download
   - Screenshot alert and download source
   - Note any error messages

4. Report to security team
   - Email: security@cyberinabox.net
   - Include: Alert details, file source, your actions

5. Await instructions
   - Don't attempt file recovery
   - Don't try to scan yourself
   - Let security team investigate
```

**For MEDIUM/LOW Alerts (Level 3-9):**

```
WITHIN 1 HOUR:

1. Review alert in Wazuh dashboard
   - Access: https://wazuh.cyberinabox.net
   - Find your alert
   - Read full details

2. Document what you were doing
   - What websites were you visiting?
   - What files were you downloading?
   - What applications were you using?

3. Check if legitimate activity
   - Was this normal behavior?
   - Do you recognize the file/activity?
   - Could this be a false positive?

4. Report if concerning
   - Email: security@cyberinabox.net
   - Or use AI assistant for assessment:
     ssh to system, run: claude
     Describe the alert

5. Continue monitoring
   - Watch for additional alerts
   - Note any unusual system behavior
```

### What NOT to Do

**NEVER Do These:**

```
❌ Ignore the alert
   → Malware doesn't go away by ignoring it

❌ Try to open/run the suspicious file
   → "Just checking" can cause infection

❌ Delete the file yourself
   → Need it for forensics/analysis

❌ Attempt to "clean" malware yourself
   → Can make it worse or hide evidence

❌ Clear alerts or logs
   → Needed for investigation

❌ Shutdown system without approval
   → May destroy evidence in RAM

❌ Format/reinstall without approval
   → Destroys evidence, may not remove all malware

❌ Tell others before security team
   → Can cause panic, spread misinformation

❌ Post on social media
   → Security incident details are confidential

❌ Continue working as normal
   → May spread malware or lose data
```

## 26.5 Prevention and Best Practices

### Avoiding Malware

**Safe Browsing:**

```
✓ Use only approved browsers (Firefox, Chrome with security extensions)
✓ Keep browser updated
✓ Check URLs before clicking
✓ Look for HTTPS and valid certificates
✓ Avoid suspicious websites
✓ Use ad blocker (reduces malicious ads)
✓ Don't click pop-ups

⚠️ Dangerous:
  - Piracy/warez sites
  - Unofficial software download sites
  - Sites offering "free" paid software
  - Adult content sites
  - Sites flagged by browser warnings
```

**Safe Downloads:**

```
✓ Download only from official sources
✓ Verify file hashes when provided
✓ Scan downloads with antivirus
✓ Check file extensions (beware of .exe, .scr, .bat)
✓ Be suspicious of unsolicited attachments

⚠️ Red Flags:
  - File extension mismatch (PDF.exe)
  - Multiple extensions (photo.jpg.exe)
  - Unexpected file type
  - Very small "document" files
  - Executable files from email
```

**Email Safety:**

```
✓ Verify sender before opening attachments
✓ Hover over links to see real URL
✓ Be suspicious of urgent requests
✓ Check for spelling/grammar errors
✓ Verify requests through other channels

⚠️ Never Open:
  - .exe, .scr, .bat, .cmd files from email
  - Macros in Office documents from unknown senders
  - Compressed files (.zip, .rar) from strangers
  - Files that seem suspicious
```

**USB Drive Safety:**

```
✓ Use only approved/issued USB drives
✓ Scan before use: clamscan /media/usb/
✓ Don't use found USB drives
✓ Don't plug in unknown devices

⚠️ USB drives can:
  - Auto-run malware
  - Steal data automatically
  - Infect without user interaction
```

**Software Installation:**

```
✓ Request software through proper channels
✓ Use official repositories: dnf install package
✓ Verify package signatures
✓ Administrator installs system-wide software

❌ Never:
  - Install pirated software
  - Use "cracks" or "keygens"
  - Download from untrusted sources
  - Bypass software licensing
```

### System Hygiene

**Keep Systems Updated:**

```
Automatic Updates:
  - Security updates: Applied automatically
  - OS updates: Monthly maintenance window
  - Antivirus signatures: Daily (automated)
  - YARA rules: Weekly (automated)

Your Role:
  - Don't postpone system updates
  - Reboot when requested
  - Report if updates fail
  - Keep applications updated
```

**Regular Scans:**

```
Automated Scans:
  - ClamAV: Continuous on-access scanning
  - YARA: Daily full system scan (2:00 AM)
  - AIDE: Daily file integrity check
  - Wazuh: Real-time monitoring

Manual Scan (if concerned):
  sudo clamscan -r /home/username/

  Wait for completion, review results
```

**Secure Configurations:**

```
✓ Use firewall (firewalld enabled by default)
✓ SELinux enforcing mode (do not disable)
✓ Automatic updates enabled
✓ Audit logging active
✓ File integrity monitoring (AIDE)

Your Settings:
  - Don't disable security features
  - Don't run services as root unnecessarily
  - Use least privilege (don't sudo everything)
  - Lock screen when away
```

## 26.6 After an Incident

### System Restoration

**If Your System Was Infected:**

```
Security team will:

1. Forensic Analysis (1-4 hours)
   - Determine infection vector
   - Assess scope of compromise
   - Identify data accessed
   - Collect evidence

2. System Remediation (2-8 hours)
   - Remove malware and artifacts
   - Verify system integrity
   - Restore from backup if needed
   - Update security controls

3. Account Security (immediate)
   - Force password change
   - Revoke certificates/SSH keys
   - Review access logs
   - Reset MFA tokens

4. Return to Service (varies)
   - Full system scan clean
   - Monitoring deployed
   - User training (if needed)
   - Return system to user

Your Actions During:
  - Use temporary workstation if provided
  - Answer questions about your activity
  - Change passwords on all accounts
  - Review account activity logs
```

### Lessons Learned

**Post-Incident Review:**

```
You may be asked to:

1. Timeline interview
   - What were you doing?
   - What did you click?
   - What emails did you receive?
   - What files did you download?

2. Awareness training
   - Review incident specifics
   - Learn to recognize similar threats
   - Practice safe behaviors
   - Understand the impact

3. Process improvement
   - What could have prevented this?
   - Were warnings clear?
   - What would help in future?
   - Any system improvements needed?

Purpose: Learning, not blame
  - Improve defenses for everyone
  - Prevent similar incidents
  - Strengthen security culture
```

### Prevention Going Forward

**After experiencing an incident:**

```
Recommended Actions:

1. Review your security practices
   - Am I clicking links carefully?
   - Do I verify sender before opening attachments?
   - Do I use strong, unique passwords?
   - Is my password manager up to date?

2. Stay vigilant
   - Take extra time to review emails
   - Think before clicking
   - When in doubt, ask (security team or AI assistant)

3. Share learnings (appropriately)
   - Help colleagues learn from your experience
   - Share anonymized lessons learned
   - Promote security awareness

4. Stay informed
   - Read security updates
   - Attend training sessions
   - Ask questions
   - Use resources available
```

---

**Malware Detection Quick Reference:**

**Detection Systems:**
- ClamAV: Real-time antivirus
- YARA: Pattern-based detection
- Wazuh: Security monitoring (SIEM)
- Suricata: Network-based detection
- AIDE: File integrity monitoring

**Alert Levels:**
- 12-15 (Critical): Active malware, immediate action
- 10-11 (High): Malware detected, urgent response
- 7-9 (Medium): Suspicious activity, investigate
- 3-6 (Low): Informational, logged

**When You Get an Alert:**

**Critical (Level 12+) - Within 1 Minute:**
1. Stop what you're doing
2. Isolate system (unplug network)
3. Don't delete anything
4. Email security@cyberinabox.net immediately
5. Change password from different device

**High (Level 10-11) - Within 5 Minutes:**
1. Read alert details
2. Note what you were doing
3. Screenshot the alert
4. Report to security team
5. Await instructions

**Medium/Low - Within 1 Hour:**
1. Review alert in Wazuh dashboard
2. Check if legitimate activity
3. Report if concerning
4. Monitor for additional alerts

**Prevention:**
- ✓ Download only from official sources
- ✓ Don't open unexpected email attachments
- ✓ Verify links before clicking
- ✓ Keep systems updated
- ✓ Use strong passwords
- ✓ Report suspicious activity

**DON'T:**
- ❌ Ignore alerts
- ❌ Try to clean malware yourself
- ❌ Delete evidence
- ❌ Open suspicious files to "check"
- ❌ Continue working normally after alert

**Dashboards:**
- Wazuh: https://wazuh.cyberinabox.net
- YARA Dashboard: https://grafana.cyberinabox.net
- CPM Status: https://cpm.cyberinabox.net

**For Help:**
- Security Team: security@cyberinabox.net
- Emergency: [Phone - Chapter 5]
- AI Assistant: `claude` via SSH
- Administrator: dshannon@cyberinabox.net

---

**Related Chapters:**
- Chapter 5: Quick Reference Card
- Chapter 17: Wazuh Security Monitoring
- Chapter 18: Suricata Network Security
- Chapter 19: Grafana Dashboards (YARA)
- Chapter 22: Incident Response
- Chapter 25: Reporting Security Issues
- Appendix D: Troubleshooting Guide

**Manual Scanning:**
```bash
# Scan home directory
sudo clamscan -r /home/username/

# Scan specific file
sudo clamscan /path/to/suspicious/file

# Check YARA scan status
systemctl status yara-scan

# View recent Wazuh alerts
# Access: https://wazuh.cyberinabox.net
```

**Current Status:**
- Malware detections: 0 (clean environment)
- YARA scans: Daily, all clear
- ClamAV: Up to date, active protection
- Wazuh: Monitoring all systems, 24/7
